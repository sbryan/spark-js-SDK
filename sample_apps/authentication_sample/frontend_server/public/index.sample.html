<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Spark Sample Application</title>
        <meta charset="utf-8">
        <!-- Bootstrap core CSS -->
        <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">

        <style>
            #login-button, #logout-button,#implicit-login-button{display: none}
        </style>
    </head>

    <body>
        <div class="container">
            <div class="col-md-6 col-md-offset-3">
                <div id="welcome-wrapper">
                    <h2>Spark SDK Authentication Sample</h2>

                    <div class="col-md-10 col-md-offset-1" id="login">
                        <p>Guest Token: <span id="guest-token-span">none</span></p>
                        <p>Access Token: <span id="access-token-span">none</span></p>

                        <button id="login-button" class="btn btn-primary">Login</button>
	                    <button id="implicit-login-button" class="btn btn-primary">Implicit Login</button>
	                    <button id="logout-button" class="btn btn-danger">Logout</button>
                        <button id="guest-button" class="btn btn-primary">Get Guest Token</button>
                        <br>
                        <p>Info:<br>
                        <pre id="profile"></pre>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <br>
        <div class="container">
            <div class="col-md-6 col-md-offset-3">
                <div id="test-wrapper-printer-types">
                    <h2>Spark SDK Test</h2>

                    <div class="col-md-10 col-md-offset-1">
                        <button id="printer-types" class="btn btn-primary">Get Printer Types</button>
                        <br>
                        <p>Printer Types:<br>
                        <pre id="printer-types-list"></pre>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <br>
        <div class="container">
            <div class="col-md-6 col-md-offset-3">
                <div id="test-wrapper-upload-file">
                    <h2>Spark SDK Mesh Import Test</h2>

                    <div class="col-md-10 col-md-offset-1">
                        <form id="upload-form">
                         <input id="upload-file" class="btn btn-primary" type="file" />
                        </form>
                        <p>Status:<br>
                        <pre id="upload-log"></pre>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <br>
        <div class="container">
            <div class="col-md-6 col-md-offset-3">
                <div id="test-wrapper-analyze-mesh">
                    <h2>Spark SDK Mesh Analyze Test</h2>

                    <div class="col-md-10 col-md-offset-1">
                        <button id="analyze" class="btn btn-primary">Analyze Mesh</button>
                        <p>Status:<br>
                        <pre id="analyze-log"></pre>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <br>
        <div class="container">
            <div class="col-md-6 col-md-offset-3">
                <div id="test-wrapper-analyze-mesh">
                    <h2>Spark SDK Mesh Repair Test</h2>

                    <div class="col-md-10 col-md-offset-1">
                        <button id="repair" class="btn btn-primary">Repair Mesh</button>
                        <p>Status:<br>
                        <pre id="repair-log"></pre>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <br>
        <div class="container">
            <div class="col-md-6 col-md-offset-3">
                <div id="test-wrapper-create-tray">
                    <h2>Spark SDK Create Tray Test</h2>

                    <div class="col-md-10 col-md-offset-1">
                        <button id="tray" class="btn btn-primary">Create Tray</button>
                        <p>Status:<br>
                        <pre id="tray-log"></pre>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <br>
        <div class="container">
            <div class="col-md-6 col-md-offset-3">
                <div id="test-wrapper-prepare-tray">
                    <h2>Spark SDK Prepare Tray Test</h2>

                    <div class="col-md-10 col-md-offset-1">
                        <button id="prepare" class="btn btn-primary">Prepare Tray</button>
                        <p>Status:<br>
                        <pre id="prepare-log"></pre>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <br>
        <div class="container">
            <div class="col-md-6 col-md-offset-3">
                <div id="test-wrapper-prepare-tray">
                    <h2>Spark SDK Generate Printable Test</h2>

                    <div class="col-md-10 col-md-offset-1">
                        <button id="printable" class="btn btn-primary">Generate Prinable</button>
                        <p>Status:<br>
                        <pre id="printable-log"></pre>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <br>
        <div class="container">
            <div class="col-md-6 col-md-offset-3">
                <div id="test-wrapper-job">
                    <h2>Spark SDK Create Print Job Test</h2>

                    <div class="col-md-10 col-md-offset-1">
                        <form id="job-form">
                              <label>Printer ID: </label><input type="text" id="printerId" name="printerId" class="required"><br>
                              <label>Profile ID: </label><input type="text" id="profileId" name="profileId" class="required" size=44 value="34F0E39A-9389-42BA-AB5A-4F2CD59C98E4">
                              <label>Printable ID: </label><input type="text" id="printableId" name="printableId" class="required">
                        </form>
                        <button id="job" class="btn btn-primary">Create Print Job</button>
                        <p>Status:<br>
                        <pre id="job-log"></pre>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <br>
        <div class="container">
            <div class="col-md-6 col-md-offset-3">
                <div id="test-wrapper-jobs-list">
                    <h2>Spark SDK Job Status Test</h2>

                    <div class="col-md-10 col-md-offset-1">
                        <button id="job-status" class="btn btn-primary">Get Print Job Status</button>
                        <p>Status:<br>
                        <pre id="job-status-log"></pre>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <br>
        <div class="container">
            <div class="col-md-6 col-md-offset-3">
                <div id="test-wrapper-printer-list">
                    <h2>Spark SDK Printers Test</h2>

                    <div class="col-md-10 col-md-offset-1">
                        <button id="printers" class="btn btn-primary">Get Registered Printers</button>
                        <p>Status:<br>
                        <pre id="printer-list"></pre>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <br>
        <div class="container">
            <div class="col-md-6 col-md-offset-3">
                <div id="test-wrapper-jobs-list">
                    <h2>Spark SDK Jobs Test</h2>

                    <div class="col-md-10 col-md-offset-1">
                        <button id="jobs" class="btn btn-primary">Get Users Print Jobs</button>
                        <p>Status:<br>
                        <pre id="job-list"></pre>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- /container -->

        <script type="text/javascript" charset="utf-8" src="//code.jquery.com/jquery-2.1.3.min.js"></script>

        <!-- spark sdk -->
        <!-- TODO: For now include the source directly. Change this to installed minified source file -->
        <script type="text/javascript" charset="utf-8" src="utilities/Helpers.js"></script>
        <script type="text/javascript" charset="utf-8" src="utilities/Paginated.js"></script>
        <script type="text/javascript" charset="utf-8" src="utilities/Request.js"></script>
        <script type="text/javascript" charset="utf-8" src="config/Constants.js"></script>
        <script type="text/javascript" charset="utf-8" src="Client.js"></script>
        <script type="text/javascript" charset="utf-8" src="drive/Members.js"></script>
        <script type="text/javascript" charset="utf-8" src="PrintDB.js"></script>
        <script type="text/javascript" charset="utf-8" src="Printer.js"></script>
        <script type="text/javascript" charset="utf-8" src="MeshAPI.js"></script>
        <script type="text/javascript" charset="utf-8" src="TrayAPI.js"></script>
        <script type="text/javascript" charset="utf-8" src="Job.js"></script>
        <script type="text/javascript" charset="utf-8" src="Tasks.js"></script>
        <!-- end spark sdk -->

        <script>
            var APP_KEY = ''; // Your app key

            // The guest token endpoint that is implemented by your server (i.e. http://example.com/guest_token)
            var GUEST_TOKEN_URL = 'http://localhost:3000/guest_token';
            // The access token endpoint that is implemented by your server (i.e. http://example.com/access_token)
            var ACCESS_TOKEN_URL = 'http://localhost:3000/access_token';
            // The refresh token endpoint that is implemented by your server (i.e. http://example.com/refresh_token)
            var REFRESH_TOKEN_URL = 'http://localhost:3000/refresh_token';


            /**
             * Run when DOM is ready.
             * The spark object already exists in this point
             */
            jQuery(function ($) {
                var MeshAPI = ADSKSpark.MeshAPI;
                var TrayAPI = ADSKSpark.TrayAPI;
                var Client  = ADSKSpark.Client;

                var _meshID = null;
                var _trayID = null;
                var _preparedTrayID = null;
                var _printerTypes = null;
                var _printableFileID = null;
                var _printJob = null;
	            var isServerLogin = (window.location.search.indexOf('code') != -1);

	            Client.initialize(APP_KEY,false,'', GUEST_TOKEN_URL, ACCESS_TOKEN_URL, REFRESH_TOKEN_URL);

                //First let's see if we have a valid access token
                if (Client.isAccessTokenValid()) {
                    $('#access-token-span').text(Client.getAccessToken());
                    $('#logout-button').show();

                    ADSKSpark.Members.getMyProfile().then(function(data) {
                        var report = 'Name: ' + data.member.name + '\n';
                        report += 'Email: ' + data.member.email + '\n';
                        report += 'Member ID: ' + data.member.id + '\n';
                        $('#profile').text(report);
                        $('#login').append('<img src="' + data.member.profile.avatar_path + '"/>');
                    });
                } else {
                    //user needs to login
                    $('#login-button').show();
	                $('#implicit-login-button').show();

		                Client.completeLogin(isServerLogin).then(function (token) {
			                console.log('Completed login with token: ' + token);

			                if (token) {
				                //You can redirect now to some page in your app or to homepage
				                // or to reload the top window or any other action
				                window.location.reload();
			                } else {
				                console.error('Problem with fetching token');
			                }

		                }, function (error) {

			                console.error(error.message);
			                $('#profile').text(error.message);
		                });




                }

                // Register buttons
                $('#login-button').click(function() {
                    window.location = Client.getLoginRedirectUrl(false,true);
                });

	            $('#implicit-login-button').click(function() {
		            window.location = Client.getLoginRedirectUrl();
	            });

                $('#logout-button').click(function() {
                    Client.logout();
	                window.location.assign(ADSKSpark.Helpers.calculateRedirectUri());
                });

                $('#guest-button').click(function() {
                    Client.getGuestToken().then(function(token) {
                        $('#guest-token-span').text(token);
                    });
                });

                $('#printer-types').click(function() {
                    ADSKSpark.PrintDB.getPrinterTypes().then(function(types) {
                        _printerTypes = types;
                        for( var i=types.length;  --i >= 0; ) {
                            var p = types[i];
                            var report = p.manufacturer + ': <b>' + p.name + '</b> [' + p.technology + ']<br>';
                            $('#printer-types-list').append(report);
                        }
                    })
                    .catch( function(error) {
                        _printerTypes = null;
                        $('#printer-types-list').text(error.message);
                    });
                });

                $('#upload-file').change(function(event) {
                    var file = this.files[0];
                    $('#upload-log').append('<b>Uploading...</b>');
                    MeshAPI.uploadFile(file)
                        .then(function(result) {
                            var upload = result.files[0];
                            var report = '\n<b>Uploaded file:</b> ' + upload.name +
                                         ' ID: ' + upload.file_id +
                                         ' typeof(ID): ' + typeof(upload.file_id) + '\n\n';
                            $('#upload-log').append(report);

                            function updateProgress(progress) {
                                var report = '<b>Import progress:</b> ' + progress + '\n';
                                $('#upload-log').append(report);
                            }
                            return MeshAPI.importMesh(upload.file_id, upload.name, true, null, updateProgress);
                        })
                        .then(function(mesh) {
                            _meshID = mesh.id;
                            var report = '<b>Imported mesh:</b> ' + mesh.name + ' ID: ' + mesh.id + '\n';
                            report += '<b>Visual file:</b> ' + mesh.visual_file_id + '\n';
                            $('#upload-log').append(report);
                            $('#analyze-log').text(''); // Clear the analyze results
                        })
                        .catch(function(err) {
                            var report = '<b>ERROR:</b> ' + err.message + '\n';
                            if( err.responseText )
                                report += '<b>Response:</b> ' + err.responseText + '\n';
                            $('#upload-log').append(report);
                        });
                });

                $('#analyze').click(function(event) {
                    if( _meshID !== null ) {
                        $('#analyze-log').append('<b>Starting Analyze: ' + _meshID + '...</b>');
                        function updateProgress(progress) {
                            var report = '<b>Analyze progress:</b> ' + progress + '\n';
                            $('#analyze-log').append(report);
                        }

                        MeshAPI.analyzeMesh(_meshID, updateProgress)
                            .then(function(result) {
                                if( result.problems.length > 0 ) {
                                    for( var i=result.problems.length; --i >= 0; ) {
                                        var problem = result.problems[i];
                                        var report = '\n<b>Found problem:</b> ' + problem.type + '\n';
                                        $('#analyze-log').append(report);
                                    }
                                }
                                else {
                                    $('#analyze-log').append('\nNo problems found!');
                                }
                            })
                            .catch(function(err) {
                                var report = '<b>ERROR:</b> ' + err.message + '\n';
                                if( err.responseText )
                                    report += '<b>Response:</b> ' + err.responseText + '\n';
                                $('#analyze-log').append(report);
                            });
                    }
                    else {
                        $('#analyze-log').append('<b>Import Mesh first, then try analyze</b>\n');
                    }
                });

                $('#repair').click(function(event) {
                    if( _meshID !== null ) {
                        $('#repair-log').append('<b>Starting Repair: ' + _meshID + '...</b>');
                        function updateProgress(progress) {
                            var report = '<b>Repair progress:</b> ' + progress + '\n';
                            $('#repair-log').append(report);
                        }

                        MeshAPI.repairMesh(_meshID, true, updateProgress)
                            .then(function(mesh) {
                                if( mesh.problems.length > 0 ) {
                                    for( var i=mesh.problems.length; --i >= 0; ) {
                                        var problem = mesh.problems[i];
                                        var report = '\n<b>Found problem:</b> ' + problem.type + '\n';
                                        $('#repair-log').append(report);
                                    }
                                }
                                else {
                                    _meshID = mesh.id;  // Use this one now.
                                    $('#repair-log').append('\nNo problems found!');
                                }
                                var report = '\n<b>New Mesh:</b> ' + mesh.id + '\n';
                                report += '<b>Visual file:</b> ' + mesh.visual_file_id + '\n';
                                $('#repair-log').append(report);
                            })
                            .catch(function(err) {
                                var report = '<b>ERROR:</b> ' + err.message + '\n';
                                if( err.responseText )
                                    report += '<b>Response:</b> ' + err.responseText + '\n';
                                $('#repair-log').append(report);
                            });
                    }
                    else {
                        $('#repair-log').append('<b>Import Mesh first, then try repair</b>\n');
                    }
                });

                $('#tray').click(function(event) {
                    if( _meshID !== null ) {
                        function createTray() {
                            var printerType = _printerTypes[0];
                            var printerTypeId    = printerType.id;
                            var printerProfileId = printerType.default_profile_id;

                            $('#tray-log').append('<b>Start Tray Create:</b> using printer type: ' + printerType.name + '...');
                            function updateProgress(progress) {
                                var report = '<b>Tray progress:</b> ' + progress + '\n';
                                $('#tray-log').append(report);
                            }

                            TrayAPI.createTray(printerTypeId, printerProfileId, [_meshID], null, null, updateProgress)
                                .then(function(tray) {
                                    _trayID = tray.id;
                                    var report = '\n<b>New Tray:</b> ' + tray.id + ' ' + tray.state + ' Ready: ' + tray.ready + '\n';
                                    $('#tray-log').append(report);
                                    $('#tray-log').append('Tray has ' + tray.meshes.length + ' meshes.\n');
                                })
                                .catch(function(err) {
                                    var report = '<b>ERROR:</b> ' + err.message + '\n';
                                    if( err.responseText )
                                        report += '<b>Response:</b> ' + err.responseText + '\n';
                                    $('#tray-log').append(report);
                                });
                        }
                        if( _printerTypes === null ) {
                            ADSKSpark.PrintDB.getPrinterTypes().then(function(types) {
                                $('#tray-log').append('Fetched printer types...');
                                _printerTypes = types;
                                createTray();
                            });
                        }
                        else
                            createTray();
                    }
                    else {
                        $('#tray-log').append('<b>Import Mesh first, then try create tray</b>\n');
                    }
                });

                $('#prepare').click(function(event) {
                    if( _trayID !== null ) {
                        $('#prepare-log').append('<b>Start Tray Prepare:</b> tray: ' + _trayID + '...');
                        function updateProgress(progress) {
                            var report = '<b>Tray progress:</b> ' + progress + '\n';
                            $('#prepare-log').append(report);
                        }

                        TrayAPI.prepareTray(_trayID, true, updateProgress)
                            .then(function(tray) {
                                if( tray.ready )
                                    _preparedTrayID = tray.id;

                                var report = '\n<b>New Tray:</b> ' + tray.id + ' ' + tray.state + ' Ready: ' + tray.ready + '\n';
                                $('#prepare-log').append(report);
                                $('#prepare-log').append('Tray has ' + tray.meshes.length + ' meshes.\n');
                                $('#prepare-log').append('Mesh visual: ' + tray.meshes[0].visual_file_id + '\n');
                            })
                            .catch(function(err) {
                                var report = '<b>ERROR:</b> ' + err.message + '\n';
                                if( err.responseText )
                                    report += '<b>Response:</b> ' + err.responseText + '\n';
                                $('#prepare-log').append(report);
                            });
                    }
                    else {
                        $('#prepare-log').append('<b>Create Tray first, then try Prepare.</b>\n');
                    }
                });

                $('#printable').click(function(event) {
                    if( _preparedTrayID !== null ) {
                        $('#printable-log').append('<b>Start Printable:</b> tray: ' + _preparedTrayID + '...');
                        function updateProgress(progress) {
                            var report = '<b>Printable progress:</b> ' + progress + '\n';
                            $('#printable-log').append(report);
                        }

                        TrayAPI.generatePrintable(_preparedTrayID, updateProgress)
                            .then(function(result) {
                                _printableFileID = result.file_id;
                                $('#printableId').val(_printableFileID);
                                var report = '\n<b>Printable File ID:</b> ' + result.file_id + '\n';
                                $('#printable-log').append(report);
                            })
                            .catch(function(err) {
                                var report = '<b>ERROR:</b> ' + err.message + '\n';
                                if( err.responseText )
                                    report += '<b>Response:</b> ' + err.responseText + '\n';
                                $('#printable-log').append(report);
                            });
                    }
                    else {
                        $('#printable-log').append('<b>Prepare Tray first, then try Generate Printable.</b>\n');
                    }
                });

                $('#job').click(function(event) {
                    var printerId = $('#printerId').val();
                    var profileId = $('#profileId').val();
                    var printableId = $('#printableId').val();

                    if( printerId && profileId && printableId ) {
                        _printJob = new ADSKSpark.Job();

                        _printJob.createWithProfile(profileId, printerId, printableId)
                            .then(function(job) {
                                var report = '<b>Job ID:</b> ' + job.id + ' Status: ' + job.status + ' Progress: ' + job.progress + '\n';
                                $('#job-log').append(report);
                            })
                            .catch(function(err) {
                                var report = '<b>ERROR:</b> ' + err.message + '\n';
                                if( err.responseText )
                                    report += '<b>Response:</b> ' + err.responseText + '\n';
                                $('#job-log').append(report);
                            });
                    }
                    else {
                        $('#job-log').append('<b>Must specify Printer, Profile and Printable IDs.</b>\n');
                        $('#job-log').append('<b>Use Generate Printable to get a Printable ID.</b>\n');
                    }
                });

                $('#job-status').click(function(event) {
                    if( _printJob !== null ) {
                        _printJob.getStatus()
                            .then(function(job) {
                                var report = '<b>Job ID:</b> ' + job.id + ' Status: ' + job.status + ' Progress: ' + job.progress + '\n';
                                $('#job-status-log').append(report);
                            })
                            .catch(function(err) {
                                var report = '<b>ERROR:</b> ' + err.message + '\n';
                                if( err.responseText )
                                    report += '<b>Response:</b> ' + err.responseText + '\n';
                                $('#job-status-log').append(report);
                            });
                    }
                    else {
                        $('#job-status-log').append('<b>No print job active! Try Create Print Job first.</b>\n');
                    }
                });

                $('#printers').click(function() {
                    ADSKSpark.Printers.get().then(function(printers) {
                        if( printers.length === 0 ) {
                            $('#printer-list').append('No Printers Found\n');
                        } else {
                            var report = '';
                            printers.forEach(function (printer) {
                                report += '<b>Printer[' + printer.printer_id + ']:</b> Name: ' + printer.printer_name
                                    + ' Type: ' + printer.type_id
                                    + ' Status: ' + printer.printer_last_health + '\n';
                            });
                            $('#printer-list').html(report);
                        }
                    })
                    .catch( function(error) {
                        $('#printer-list').text(error.message);
                    });
                });

                $('#jobs').click(function() {
                    ADSKSpark.Jobs.get().then(function(jobs) {
                        if( jobs.length === 0 ) {
                            $('#job-list').append('No Jobs Found\n');
                        } else {
                            var report = '';
                            jobs.forEach(function(job) {
                                report += '<b>Job[' + job.id + ']:</b> Printer: ' + job.printer_id
                                + ' Status: ' + job.status
                                + ' Date: ' + job.data.job_date_time + '\n';
                            });
                            $('#job-list').html(report);
                        }
                    })
                    .catch( function(error) {
                        $('#job-list').text(error.message);
                    });
                });

            });
        </script>
    </body>
</html>
